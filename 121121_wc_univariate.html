<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link href="css/wc_style.css" rel="stylesheet">
</head>
<body>


<form class = "past_notes">
Zip Code: <INPUT TYPE="text" NAME="zip" maxlength="5" size="5" VALUE="">&nbsp;
<INPUT TYPE="button" NAME="button" Value="Update" onClick="process_input(this.form)">
<p></p>
</form>



<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script type="text/javascript" src="js/d3.v2.js"></script>
<script type="text/javascript" src="js/psMathStats.js"></script>

<script>
    //global functions
    Array.prototype.getUnique = function(){
       var u = {}, a = [];
       for(var i = 0, l = this.length; i < l; ++i){
          if(u.hasOwnProperty(this[i])) {
             continue;
          }
          a.push(this[i]);
          u[this[i]] = 1;
       }
       return a;
    }
        
    var FormatNumberLength = function(num, length) {
      var r = "" + num;
      while (r.length < length) {
          r = "0" + r;
      }
      return r;
    }
           
    var processZip = function(zip) {
      console.log("Processing zip code...");
      var wu_geo = "http://api.wunderground.com/api/0741f932b52dd34a/geolookup/q/"+ zip + ".json";
      jQuery(document).ready(function($) {
        $.ajax({
        url : wu_geo,
        dataType : "jsonp",
          success : function(parsed_json) {
            var city = parsed_json.location.city;
            var state = parsed_json.location.state;
            console.log("Zip code identified:");
            console.log(city);
            console.log(state);
            getForecast(zip);
            }//close callback
            });//end of ajax
          });//end of jQuery
    }
                  
    var setupInput = function() {
      console.log("Setup input");
      var select_zip = document.getElementsByName("zip")[0];
      select_zip.value = zip_now;
    }
      
    var getNow = function(zip) {
      var variables_json = ["dewpoint_f", "relative_humidity", "temp_f", "visibility_mi", "wind_mph"];
      //make query for and draw current
      var wu_url = "http://api.wunderground.com/api/" + seed_key_wu + "/geolookup/conditions/q/" + zip + ".json";
      jQuery(document).ready(function($) {
        $.ajax({
        url : wu_url,
        dataType : "jsonp",
        success : function(parsed_json) {
          console.log("WU success");
          data_now = new Array(variables_json.length);
        for(var i = 0; i<variables_json.length; i++) {
          data_now[i] = {"variable": variables[i]};
          data_now[i].value = parseFloat(parsed_json['current_observation'][variables_json[i]]);
          data_now[i].city = parsed_json['location']['city'];
          data_now[i].state = parsed_json['location']['state'];
          data_now[i].time = parsed_json['current_observation']['observation_time'];
          if(variables[i] === "visibility") {current_viz = data_now[i].value;}
          }
          console.log(data_now);
        }
        });

      });//end of jQuery
    }
    
    var getForecast = function(zip) {
    //make query for and draw forecast
    var wu_fcast_url = "http://api.wunderground.com/api/" + seed_key_wu + "/hourly/q/" + zip + ".json";
      jQuery(document).ready(function($) {
      $.ajax({
      url : wu_fcast_url,
      dataType : "jsonp",
      success : function(parsed_json) {
        console.log("WU Success forecast");
      var series_fcast = [];
      var temp = new Array(variables.length);
      var str_times = new Array(parsed_json.hourly_forecast.length);
      for(var i = 0; i<parsed_json.hourly_forecast.length; i++) {
          str_times[i] = "h"+i;
      }
      
      for(var i = 0; i<parsed_json.hourly_forecast.length; i++) {
            //get data
            var obs = [{
              "variable": "dew_point", 
              "value": parseFloat(parsed_json.hourly_forecast[i].dewpoint.english)},
            {
              "variable": "humidity",
              "value": parseFloat(parsed_json.hourly_forecast[i].humidity)},
            {
              "variable": "temp",
              "value": parseFloat(parsed_json.hourly_forecast[i].temp.english)},
            {
              "variable": "visibility",
              "value": 10},
            {
              "variable": "wind_speed",
              "value": parseFloat(parsed_json.hourly_forecast[i].wspd.english)}];
            series_fcast.push(obs);
        }//end of i loop
        
        data_fcast = new Array(variables.length);
        for(var i = 0; i<variables.length; i++) {
          data_fcast[i] = [];
          for(var j=0; j<series_fcast.length; j++) {
            data_fcast[i].push(series_fcast[j][i].value);
          }                
        }
        
        console.log(data_fcast);
        //get series of differences
        data_fcast_diff = new Array(variables.length);
         for(var i = 0; i<variables.length; i++) {
          data_fcast_diff[i] = [];
          for(var j=0; j<series_fcast.length-1; j++) {
            data_fcast_diff[i].push(series_fcast[j+1][i].value-series_fcast[j][i].value);
          }                
        }
        
        stats = new Array(variables.length);
        //calc forecast stats
        for(var i = 0; i<variables.length; i++) {
            stats[i] = {};
            stats[i].variable = variables[i];
            stats[i].mean = ps.array(data_fcast[i]).mean();
            stats[i].sd = ps.array(data_fcast[i]).stdDev();
            stats[i].diff_mean = ps.array(data_fcast_diff[i]).mean();
            stats[i].diff_sd = ps.array(data_fcast_diff[i]).stdDev();
            
            if(stats[i].sd === 0) {stats[i].sd = 1;}
        }
        getNow(zip);
      }//close callback
      });//end of ajax
    });//end of jQuery
    }
          
          
</script>

<script>
  var variables = ["dew point", "humidity", "temp", "visibility", "wind_speed"];
  var zip_now = 12758;
  var seed_key_wu = "0741f932b52dd34a";
  var data_now, data_fcast, stats;
  var lims = new Array(5);
  lims[0] = {"variable": "dew_point", "max": 100,"min": -10};
  lims[1] = {"variable": "humidity", "max": 100,"min": 0};
  lims[2] = {"variable": "temp", "max": 100,"min": -10};
  lims[3] = {"variable": "visibility", "max": 10,"min": 0};
  lims[4] = {"variable": "wind_speed", "max": 50,"min": 0};
  
  console.log('Execution thread');
  setupInput();
  processZip(zip_now);

  //get current condition
  
</script>



</body>
</html>